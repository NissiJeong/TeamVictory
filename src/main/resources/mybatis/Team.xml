<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper    
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"    
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- namespace속성:매퍼파일의 완전한경로 .xml는 생략 -->
<!-- ※ibatis와는 다르게 id값에 .(dot)를 사용 못한다. -->

<mapper namespace="mybatis.Team">

	<!-- 팀게시판 -->
	<!-- 팀소개 구하기 -->
	<select id="TeamSelf" parameterType="java.util.Map" resultType="TeamBoardDTO">
		SELECT t.teamlogo, t.teamname, m.name, t.regidate, t.teamloc, t.teaminfo FROM teammember tm JOIN member m ON tm.id=m.id JOIN team t ON tm.teamname=t.teamname WHERE m.id=t.manager_id and t.teamname=(select teamname from (select * from teammember order by regidate) where id=#{id}  and rownum = 1)
	</select>
	<!-- 선수단구하기 -->
	<select id="TeamBoardList" parameterType="java.util.Map" resultType="TeamBoardDTO">
		SELECT * FROM member m JOIN teammember t ON m.id = t.id where t.teamname 
       =(select teamname from (select * from teammember order by regidate) where id=#{id}  and rownum = 1)
	</select>
	
	<!-- 최다득점 TOP3 -->
	<select id="BestrbiPlayer" parameterType="java.util.Map" resultType="TeamBoardDTO">
		select h.rbi, t.teamname, m.name from teammember t JOIN hitter h ON t.id=h.id JOIN member m ON t.id=m.id where t.teamname=(select teamname from (select * from teammember order by regidate) where id=#{id}  and rownum = 1) and 
		<![CDATA[ 
		 rownum<=3 
		]]> 
		ORDER BY h.rbi DESC
	</select>
	
	<!-- 최다삼진 TOP3 -->
	<select id="BestsoPlayer" parameterType="java.util.Map" resultType="TeamBoardDTO">
		select p.so, t.teamname, m.name from teammember t JOIN pitcher p ON t.id=p.id JOIN member m ON t.id=m.id where t.teamname=(select teamname from (select * from teammember order by regidate) where id=#{id}  and rownum = 1) and  
		<![CDATA[ 
		 rownum<=3  
		]]> 
		 ORDER BY p.so DESC
	</select>
	
	<!-- 최다홈런 TOP3 -->
	<select id="BesthrPlayer" parameterType="java.util.Map" resultType="TeamBoardDTO">
		select h.hr, t.teamname, m.name from teammember t JOIN hitter h ON t.id=h.id JOIN member m ON t.id=m.id where t.teamname=(select teamname from (select * from teammember order by regidate) where id=#{id}  and rownum = 1) and
		<![CDATA[ 
		 rownum<=3 
		]]> 
		ORDER BY h.hr DESC
	</select>
	
	<!-- 최다도루 TOP3 -->
	<select id="BestsbPlayer" parameterType="java.util.Map" resultType="TeamBoardDTO">
		select h.sb, t.teamname, m.name from teammember t JOIN hitter h ON t.id=h.id JOIN member m ON t.id=m.id 
		WHERE t.teamname=(select teamname from (select * from teammember order by regidate) where id=#{id}  and rownum = 1) and 
		<![CDATA[ 
		 rownum<=3 
		]]> 
		ORDER BY h.sb DESC
	</select>
	
	<!-- 경기일정 -->
	<select id="GameSchedule" parameterType="java.util.Map" resultType="TeamBoardDTO">
		SELECT g.*, 
        case WHEN <![CDATA[g.awayscore > g.homescore ]]> 
		and g.awayteam=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1) THEN '승'
        
        WHEN <![CDATA[ g.awayscore < g.homescore ]]> 
        and g.teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1) THEN '승'  
        
        WHEN <![CDATA[ g.awayscore < g.homescore ]]> 
        and g.awayteam=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1) THEN '패' 
        
        WHEN <![CDATA[ g.awayscore > g.homescore ]]> 
        and g.teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1) THEN '패' 
         
        WHEN <![CDATA[ g.gamedate > (select sysdate from dual) ]]> 
        THEN '경기예정'
        
    	ELSE '무승부' END as re 
    	FROM gameschedule g JOIN team t ON g.teamname=t.teamname 
		WHERE g.awayteam=(select teamname from (select * from teammember order by regidate) where id=#{id}  and rownum = 1) 
        or g.teamname=(select teamname from (select * from teammember order by regidate) where id=#{id}  and rownum = 1) 
		ORDER BY g.gamedate DESC
	</select>
	
	<!-- 투수랭킹 -->
	<select id="PitcherRank" parameterType="java.util.Map" resultType="PitcherDTO">
		SELECT p.*, m.name, ROW_NUMBER() OVER(ORDER BY so DESC) as rank FROM pitcher p JOIN member m ON p.id=m.id 
		WHERE p.teamname = (select teamname from (select * from teammember order by regidate) where id=#{id}  and rownum = 1)
	</select>
	
	<!-- 타자랭킹 -->
	<select id="HitterRank" parameterType="java.util.Map" resultType="BaseBall_HitterDTO">
		SELECT h.*, m.name, ROW_NUMBER() OVER(ORDER BY r DESC) as rank FROM hitter h JOIN member m ON h.id=m.id 
		WHERE h.teamname = (select teamname from (select * from teammember order by regidate) where id=#{id}  and rownum = 1)
	</select>
	
	<!-- 팀기네스 : 최다득점 -->
	<select id="TeamGuinnessScore" parameterType="java.util.Map" resultType="TeamBoardDTO">
		SELECT (SELECT max(R) FROM hitter where teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1)) as sc, g.*, 
		case when h.r=(select max(R) from hitter where teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1)) 
            and g.teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1) 
	    	then (select g.awayteam from gameschedule g join hitter h on g.gamedate=h.gamedate 
	            	where g.teamname=(select teamname from (select * from teammember order by regidate) 
	            	where id=#{id}  and rownum = 1) and rownum=1 and h.r=(select max(R) from hitter where teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1)))
	
	    	when h.r=(select max(R) from hitter where teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1)) 
            and g.awayteam=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1) 
	        then (select g.teamname from gameschedule g join hitter h on g.gamedate=h.gamedate 
	                where g.awayteam=(select teamname from (select * from teammember order by regidate) 
	                where id=#{id}  and rownum = 1) and rownum=1 and h.r=(select max(R) from hitter where teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1))) 
		end as "ot" 
		FROM hitter h JOIN gameschedule g ON h.gamedate=g.gamedate 
		where h.r=(SELECT max(R) FROM hitter where teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1)) 
		and (g.teamname=(select teamname from (select * from teammember order by regidate) where id=#{id}  and rownum = 1) 
		or g.awayteam=(select teamname from (select * from teammember order by regidate) where id=#{id}  and rownum = 1)) and rownum=1
		ORDER BY g.gamedate DESC
	</select>
	
	<!-- 팀기네스 : 최다홈런 -->
	<select id="TeamGuinnessHomRun" parameterType="java.util.Map" resultType="TeamBoardDTO">
		SELECT (SELECT max(hr) FROM hitter where teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1)) as hr, g.*, 
		case when h.hr=(select max(hr) from hitter where teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1)) 
            and g.teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1) 
	    	then (select g.awayteam from gameschedule g join hitter h on g.gamedate=h.gamedate 
	            	where g.teamname=(select teamname from (select * from teammember order by regidate) 
	            	where id=#{id}  and rownum = 1) and rownum=1 and h.hr=(select max(hr) from hitter where teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1)))
	
	    	when h.hr=(select max(hr) from hitter where teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1)) 
            and g.awayteam=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1) 
	        then (select g.teamname from gameschedule g join hitter h on g.gamedate=h.gamedate 
	                where g.awayteam=(select teamname from (select * from teammember order by regidate) 
	                where id=#{id}  and rownum = 1) and rownum=1 and h.hr=(select max(hr) from hitter where teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1))) 
		end as "ot" 
		FROM hitter h JOIN gameschedule g ON h.gamedate=g.gamedate 
		where h.hr=(SELECT max(hr) FROM hitter where teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1)) 
		and (g.teamname=(select teamname from (select * from teammember order by regidate) where id=#{id}  and rownum = 1) 
		or g.awayteam=(select teamname from (select * from teammember order by regidate) where id=#{id}  and rownum = 1)) and rownum=1
		ORDER BY g.gamedate DESC
	</select>
	
	<!-- 팀기네스 : 최다안타 -->
	<select id="TeamGuinnessHit" parameterType="java.util.Map" resultType="TeamBoardDTO">
		SELECT (SELECT max(h) FROM hitter where teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1)) as h, g.*, 
		case when h.h=(select max(h) from hitter where teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1)) 
            and g.teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1) 
	    	then (select g.awayteam from gameschedule g join hitter h on g.gamedate=h.gamedate 
	            	where g.teamname=(select teamname from (select * from teammember order by regidate) 
	            	where id=#{id}  and rownum = 1) and rownum=1 and h.h=(select max(h) from hitter where teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1)))
	
	    	when h.h=(select max(h) from hitter where teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1)) 
            and g.awayteam=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1) 
	        then (select g.teamname from gameschedule g join hitter h on g.gamedate=h.gamedate 
	                where g.awayteam=(select teamname from (select * from teammember order by regidate) 
	                where id=#{id}  and rownum = 1) and rownum=1 and h.h=(select max(h) from hitter where teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1))) 
		end as "ot" 
		FROM hitter h JOIN gameschedule g ON h.gamedate=g.gamedate 
		where h.h=(SELECT max(h) FROM hitter where teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1)) 
		and (g.teamname=(select teamname from (select * from teammember order by regidate) where id=#{id}  and rownum = 1) 
		or g.awayteam=(select teamname from (select * from teammember order by regidate) where id=#{id}  and rownum = 1)) and rownum=1
		ORDER BY g.gamedate DESC
	</select>
	
	<!-- 팀기네스 : 최다삼진 -->
	<select id="TeamGuinnessStrikeOut" parameterType="java.util.Map" resultType="TeamBoardDTO">
		SELECT (SELECT max(so) FROM pitcher where teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1)) as so, g.*, 
		case when h.so=(select max(so) from pitcher where teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1)) 
            and g.teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1) 
	    	then (select g.awayteam from gameschedule g join pitcher h on g.gamedate=h.gamedate 
	            	where g.teamname=(select teamname from (select * from teammember order by regidate) 
	            	where id=#{id}  and rownum = 1) and rownum=1 and h.so=(select max(so) from pitcher where teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1)))
	
	    	when h.so=(select max(so) from pitcher where teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1)) 
            and g.awayteam=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1) 
	        then (select g.teamname from gameschedule g join pitcher h on g.gamedate=h.gamedate 
	                where g.awayteam=(select teamname from (select * from teammember order by regidate) 
	                where id=#{id}  and rownum = 1) and rownum=1 and h.so=(select max(so) from pitcher where teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1))) 
		end as "ot" 
		FROM pitcher h JOIN gameschedule g ON h.gamedate=g.gamedate 
		where h.so=(SELECT max(so) FROM pitcher where teamname=(select teamname from (select * from teammember order by regidate) where id=#{id} and rownum = 1)) 
		and (g.teamname=(select teamname from (select * from teammember order by regidate) where id=#{id}  and rownum = 1) 
		or g.awayteam=(select teamname from (select * from teammember order by regidate) where id=#{id}  and rownum = 1)) and rownum=1
		ORDER BY g.gamedate DESC
	</select>
	
	<!-- 서치팀 sql문 -->
	<!-- 팀목록 리스트 -->
	<select id="TeamSearchList" parameterType="java.util.Map" resultType="Map">
		SELECT t.*, m.name FROM team t JOIN member m ON m.id=t.manager_id order by teamname
	</select>
	<!-- 팀별 팀원 수 구하기 -->
	<select id="memberSelect" resultType="Map">
		select teamname,count(*) teamcount from teammember group by teamname order by teamname
	</select>
	
	<!-- 팀검색 -->
	<select id="TeamNameSearch" parameterType="java.util.Map" resultType="Map">
		SELECT t.*, m.name FROM team t JOIN member m ON m.id=t.manager_id order by teamname
	</select>
</mapper>